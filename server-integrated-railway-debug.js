const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const compression = require('compression');
const rateLimit = require('express-rate-limit');

console.log('üîç DEBUG: Starting server-integrated-railway-debug.js');
console.log('üîç DEBUG: Express imported successfully');

// Import components - use the integrated coordinator
const { DatabaseConfig, AppConfig, RedisClient, Logger } = require('./lib/infrastructure');

console.log('üîç DEBUG: Infrastructure components imported');

// Try to import the integrated coordinator, fall back to simple if not available
let CSMCoordinator;
try {
    console.log('üîç DEBUG: Attempting to import integrated-csm-coordinator');
    CSMCoordinator = require('./lib/integrated-csm-coordinator');
    console.log('üîç DEBUG: Successfully imported integrated-csm-coordinator');
} catch (error) {
    console.log('üîç DEBUG: Failed to import integrated-csm-coordinator, using basic coordinator as fallback');
    console.log('üîç DEBUG: Error:', error.message);
    CSMCoordinator = require('./lib/basic-csm-coordinator').BasicCSMCoordinator;
    console.log('üîç DEBUG: Successfully imported basic-csm-coordinator');
}

class RailwayGovWinCSMServer {
    constructor() {
        console.log('üîç DEBUG: RailwayGovWinCSMServer constructor called');
        
        this.app = express();
        console.log('üîç DEBUG: Express app created');
        
        this.appConfig = new AppConfig();
        this.dbConfig = new DatabaseConfig();
        this.logger = new Logger('info');
        console.log('üîç DEBUG: Config and logger instances created');
        
        this.redisClient = null;
        this.csmCoordinator = null;
        
        console.log('üîç DEBUG: About to setup middleware');
        this.setupMiddleware();
        console.log('üîç DEBUG: Middleware setup complete');
        
        console.log('üîç DEBUG: About to setup routes');
        this.setupRoutes();
        console.log('üîç DEBUG: Routes setup complete');
        
        console.log('üîç DEBUG: About to setup error handling');
        this.setupErrorHandling();
        console.log('üîç DEBUG: Error handling setup complete');
        
        console.log('üîç DEBUG: RailwayGovWinCSMServer constructor finished');
    }

    setupMiddleware() {
        console.log('üîç DEBUG: Setting up middleware...');
        
        this.app.use(helmet());
        console.log('üîç DEBUG: Helmet middleware added');
        
        this.app.use(cors({ origin: '*', credentials: true }));
        console.log('üîç DEBUG: CORS middleware added');
        
        this.app.use(compression());
        console.log('üîç DEBUG: Compression middleware added');
        
        this.app.use(express.json({ limit: '10mb' }));
        this.app.use(express.urlencoded({ extended: true, limit: '10mb' }));
        console.log('üîç DEBUG: JSON and URL encoded middleware added');
        
        const limiter = rateLimit({
            windowMs: 15 * 60 * 1000,
            max: 100,
            message: { error: 'Too many requests, please try again later.' }
        });
        this.app.use('/api/', limiter);
        console.log('üîç DEBUG: Rate limiter added for /api/ routes');
        
        this.app.use((req, res, next) => {
            console.log(`üîç DEBUG: Incoming request - ${req.method} ${req.url}`);
            console.log(`üîç DEBUG: Request headers:`, req.headers);
            next();
        });
        console.log('üîç DEBUG: Request logging middleware added');
        
        console.log('üîç DEBUG: All middleware setup complete');
    }

    setupRoutes() {
        console.log('üîç DEBUG: ===== STARTING ROUTE SETUP =====');
        
        // Health endpoint
        console.log('üîç DEBUG: About to register /api/v1/system/health route');
        try {
            this.app.get('/api/v1/system/health', (req, res) => {
                console.log('üîç DEBUG: /api/v1/system/health handler called');
                console.log('üîç DEBUG: Request method:', req.method);
                console.log('üîç DEBUG: Request URL:', req.url);
                console.log('üîç DEBUG: Request params:', req.params);
                console.log('üîç DEBUG: Request query:', req.query);
                
                try {
                    const responseData = {
                        status: 'ok',
                        timestamp: new Date().toISOString(),
                        uptime: process.uptime(),
                        environment: process.env.NODE_ENV || 'development',
                        service: 'GovWin CSM - Railway Production',
                        version: '1.0.0'
                    };
                    console.log('üîç DEBUG: Health response data prepared:', responseData);
                    
                    res.json(responseData);
                    console.log('üîç DEBUG: Health response sent successfully');
                } catch (handlerError) {
                    console.error('üîç DEBUG: Error in health handler:', handlerError);
                    res.status(500).json({ error: 'Health check failed', details: handlerError.message });
                }
            });
            console.log('üîç DEBUG: ‚úÖ /api/v1/system/health route registered successfully');
        } catch (routeError) {
            console.error('üîç DEBUG: ‚ùå Failed to register /api/v1/system/health route:', routeError);
        }

        // Status endpoint
        console.log('üîç DEBUG: About to register /api/v1/system/status route');
        try {
            this.app.get('/api/v1/system/status', (req, res) => {
                console.log('üîç DEBUG: ===== STATUS ENDPOINT HANDLER CALLED =====');
                console.log('üîç DEBUG: Request method:', req.method);
                console.log('üîç DEBUG: Request URL:', req.url);
                console.log('üîç DEBUG: Request originalUrl:', req.originalUrl);
                console.log('üîç DEBUG: Request params:', req.params);
                console.log('üîç DEBUG: Request query:', req.query);
                console.log('üîç DEBUG: Request headers:', req.headers);
                console.log('üîç DEBUG: Request body:', req.body);
                
                try {
                    console.log('üîç DEBUG: Building status response...');
                    const responseData = {
                        service: 'GovWin CSM - Railway Production',
                        version: '1.0.0',
                        status: 'operational',
                        timestamp: new Date().toISOString(),
                        deployment: {
                            platform: 'railway',
                            environment: process.env.NODE_ENV || 'development',
                            port: process.env.PORT || 3000
                        }
                    };
                    console.log('üîç DEBUG: Status response data prepared:', JSON.stringify(responseData, null, 2));
                    
                    console.log('üîç DEBUG: About to send JSON response...');
                    res.json(responseData);
                    console.log('üîç DEBUG: ‚úÖ Status response sent successfully');
                } catch (handlerError) {
                    console.error('üîç DEBUG: ‚ùå Error in status handler:', handlerError);
                    console.error('üîç DEBUG: Handler error stack:', handlerError.stack);
                    res.status(500).json({ 
                        error: 'Status check failed', 
                        details: handlerError.message,
                        stack: handlerError.stack
                    });
                }
            });
            console.log('üîç DEBUG: ‚úÖ /api/v1/system/status route registered successfully');
        } catch (routeError) {
            console.error('üîç DEBUG: ‚ùå Failed to register /api/v1/system/status route:', routeError);
            console.error('üîç DEBUG: Route error stack:', routeError.stack);
        }

        // Chat message endpoint
        console.log('üîç DEBUG: About to register /api/v1/chat/message route');
        try {
            this.app.post('/api/v1/chat/message', async (req, res) => {
                console.log('üîç DEBUG: /api/v1/chat/message handler called');
                
                try {
                    const { message, userId, sessionId } = req.body;
                    
                    if (!message || typeof message !== 'string' || message.trim().length === 0) {
                        return res.status(400).json({
                            success: false,
                            error: 'Message is required and must be a non-empty string'
                        });
                    }
                    
                    const finalUserId = userId || sessionId || `anonymous_${Date.now()}`;
                    
                    if (!this.csmCoordinator) {
                        return res.json({
                            success: true,
                            message: "I'm initializing the system. Please try again in a moment.",
                            escalationSuggested: true
                        });
                    }
                    
                    const result = await this.csmCoordinator.processQuery(
                        message.trim(),
                        finalUserId,
                        { userAgent: req.get('User-Agent'), ip: req.ip }
                    );
                    
                    const response = {
                        success: true,
                        queryId: result.queryId,
                        message: this.formatMessageForUI(result),
                        guidance: result.csmGuidance,
                        nextSteps: this.extractNextSteps(result),
                        escalationSuggested: result.escalationSuggested || false,
                        fromCache: result.fromCache || false,
                        timestamp: result.timestamp,
                        agentUsed: result.analysis?.targetAgent || 'auto-detected',
                        deployment: 'railway',
                        availableAgents: result.availableAgents || []
                    };
                    
                    res.json(response);
                    
                } catch (error) {
                    console.error('üîç DEBUG: Chat endpoint error:', error);
                    
                    res.status(500).json({
                        success: false,
                        message: "I'm experiencing high demand right now. Let me connect you with a Customer Success Manager who can provide immediate assistance.",
                        escalationSuggested: true
                    });
                }
            });
            console.log('üîç DEBUG: ‚úÖ /api/v1/chat/message route registered successfully');
        } catch (routeError) {
            console.error('üîç DEBUG: ‚ùå Failed to register /api/v1/chat/message route:', routeError);
        }
        
        // Log all registered routes
        console.log('üîç DEBUG: ===== LISTING ALL REGISTERED ROUTES =====');
        this.app._router.stack.forEach((middleware, index) => {
            if (middleware.route) {
                const methods = Object.keys(middleware.route.methods).join(',').toUpperCase();
                console.log(`üîç DEBUG: Route ${index}: ${methods} ${middleware.route.path}`);
            } else if (middleware.name === 'router') {
                console.log(`üîç DEBUG: Router middleware ${index}: ${middleware.regexp}`);
            } else {
                console.log(`üîç DEBUG: Middleware ${index}: ${middleware.name || 'anonymous'}`);
            }
        });
        
        console.log('üîç DEBUG: ===== ROUTE SETUP COMPLETE =====');
    }

    setupErrorHandling() {
        console.log('üîç DEBUG: Setting up error handling...');
        
        this.app.use((error, req, res, next) => {
            console.error('üîç DEBUG: ‚ùå Unhandled error caught:', error);
            console.error('üîç DEBUG: Error stack:', error.stack);
            console.log('üîç DEBUG: Request that caused error:', req.method, req.url);
            
            res.status(500).json({
                error: 'Internal server error',
                message: process.env.NODE_ENV === 'development' ? error.message : 'Something went wrong',
                debug: {
                    url: req.url,
                    method: req.method,
                    timestamp: new Date().toISOString()
                }
            });
        });
        
        console.log('üîç DEBUG: Error handling setup complete');
    }

    async initialize() {
        try {
            console.log('üîç DEBUG: ===== STARTING INITIALIZATION =====');
            console.log('üîç DEBUG: Initializing Railway GovWin CSM Server...');
            
            // Try Redis connection with fallback
            try {
                console.log('üîç DEBUG: Attempting Redis connection...');
                this.redisClient = new RedisClient(this.dbConfig.getRedisConfig());
                await this.redisClient.connect();
                console.log('üîç DEBUG: ‚úÖ Redis connected successfully');
            } catch (error) {
                console.log('üîç DEBUG: Redis not available, using memory storage fallback');
                console.log('üîç DEBUG: Redis error:', error.message);
                // Use mock Redis
                const MockRedisClient = require('./lib/mock-redis-client');
                this.redisClient = new MockRedisClient(this.dbConfig.getRedisConfig());
                await this.redisClient.connect();
                console.log('üîç DEBUG: ‚úÖ Mock Redis client connected');
            }
            
            // Initialize CSM coordinator
            console.log('üîç DEBUG: Initializing CSM coordinator...');
            this.csmCoordinator = new CSMCoordinator(
                this.redisClient,
                this.logger,
                this.appConfig.getAll()
            );
            console.log('üîç DEBUG: ‚úÖ CSM coordinator initialized');
            
            console.log('üîç DEBUG: ‚úÖ Railway server initialized successfully');
            console.log('üîç DEBUG: ===== INITIALIZATION COMPLETE =====');
            
        } catch (error) {
            console.error('üîç DEBUG: ‚ùå Failed to initialize Railway server:', error);
            console.error('üîç DEBUG: Initialization error stack:', error.stack);
            throw error;
        }
    }

    async start() {
        console.log('üîç DEBUG: ===== STARTING SERVER =====');
        
        await this.initialize();
        
        const port = process.env.PORT || 3000;
        console.log('üîç DEBUG: Server will listen on port:', port);
        
        this.server = this.app.listen(port, '0.0.0.0', () => {
            console.log('üîç DEBUG: ‚úÖ Server is now listening!');
            console.log(`üîç DEBUG: Railway GovWin CSM Server running on port ${port}`);
            console.log(`üîç DEBUG: Environment: ${process.env.NODE_ENV || 'development'}`);
            console.log('üîç DEBUG: Platform: Railway');
            console.log('üîç DEBUG: Server address:', this.server.address());
            
            // Test route accessibility
            console.log('üîç DEBUG: ===== TESTING ROUTE ACCESSIBILITY =====');
            console.log('üîç DEBUG: Health endpoint should be available at: http://0.0.0.0:' + port + '/api/v1/system/health');
            console.log('üîç DEBUG: Status endpoint should be available at: http://0.0.0.0:' + port + '/api/v1/system/status');
        });

        process.on('SIGTERM', () => {
            console.log('üîç DEBUG: Received SIGTERM signal');
            this.shutdown();
        });
        process.on('SIGINT', () => {
            console.log('üîç DEBUG: Received SIGINT signal');
            this.shutdown();
        });
        
        return this.server;
    }

    async shutdown() {
        console.log('üîç DEBUG: ===== STARTING SHUTDOWN =====');
        console.log('üîç DEBUG: Shutting down Railway server...');
        
        if (this.server) {
            console.log('üîç DEBUG: Closing HTTP server...');
            this.server.close();
            console.log('üîç DEBUG: ‚úÖ HTTP server closed');
        }
        
        if (this.redisClient) {
            console.log('üîç DEBUG: Disconnecting Redis client...');
            await this.redisClient.disconnect();
            console.log('üîç DEBUG: ‚úÖ Redis client disconnected');
        }
        
        console.log('üîç DEBUG: ‚úÖ Railway server shutdown complete');
        console.log('üîç DEBUG: ===== SHUTDOWN COMPLETE =====');
        process.exit(0);
    }

    formatMessageForUI(result) {
        console.log('üîç DEBUG: formatMessageForUI called');
        if (!result.csmGuidance || result.csmGuidance.length === 0) {
            return "I'm here to help you navigate GovWin IQ. What can I assist you with today?";
        }
        
        if (result.csmGuidance.length === 1) {
            return result.csmGuidance[0].content;
        }
        
        const primary = result.csmGuidance.find(g => g.role === 'primary');
        return primary ? primary.content : result.csmGuidance[0].content;
    }

    extractNextSteps(result) {
        console.log('üîç DEBUG: extractNextSteps called');
        const steps = [];
        
        if (result.csmGuidance) {
            result.csmGuidance.forEach(guidance => {
                if (guidance.nextSteps) {
                    steps.push(...guidance.nextSteps);
                }
            });
        }
        
        return steps;
    }
}

console.log('üîç DEBUG: About to check if this is the main module');
if (require.main === module) {
    console.log('üîç DEBUG: This is the main module, starting server...');
    const server = new RailwayGovWinCSMServer();
    server.start().catch(error => {
        console.error('üîç DEBUG: ‚ùå Failed to start Railway server:', error);
        console.error('üîç DEBUG: Startup error stack:', error.stack);
        process.exit(1);
    });
} else {
    console.log('üîç DEBUG: This module is being required, not starting server directly');
}

console.log('üîç DEBUG: About to export RailwayGovWinCSMServer class');
module.exports = RailwayGovWinCSMServer;
console.log('üîç DEBUG: Module export complete');